-- ============================================
-- 政府违建案件管理系统：一键重置测试数据脚本（修复版）
-- 功能：清空数据 → 重置ID → 插入完整测试数据 → 正确验证外键
-- ============================================

USE violation_management;

-- 开始事务（可选，便于回滚）
START TRANSACTION;

-- ============================================
-- 第一步：清空所有表（按外键依赖顺序）
-- ============================================
DELETE FROM building_violation_progress;
DELETE FROM demolition_progress;
DELETE FROM violation_case;
DELETE FROM geographical_location;

-- ============================================
-- 第二步：重置自增ID（确保从1开始）
-- ============================================
ALTER TABLE building_violation_progress AUTO_INCREMENT = 1;
ALTER TABLE demolition_progress AUTO_INCREMENT = 1;
ALTER TABLE violation_case AUTO_INCREMENT = 1;
ALTER TABLE geographical_location AUTO_INCREMENT = 1;

-- ============================================
-- 第三步：插入地理位置数据
-- ============================================
INSERT INTO geographical_location (community, address_number, latitude, longitude) VALUES
('阳光社区', '阳光路123号', 39.90420000, 116.40739600),
('阳光社区', '阳光路456号', 39.90680000, 116.40850000),
('阳光社区', '阳光路789号-A栋', 39.90950000, 116.40980000),
('幸福村', '幸福大道56号', 39.90850000, 116.41020000),
('幸福村', '幸福大道78号', 39.91020000, 116.41150000),
('和谐小区', '和谐街101号', 39.91230000, 116.41340000),
('和谐小区', '和谐街202号', 39.91450000, 116.41560000),
('工业园区', '创业路1号', 39.91670000, 116.41780000),
('工业园区', '创新路2号', 39.91890000, 116.42000000),
('测试社区', '边界路001号', -90.00000000, -180.00000000),
('测试社区', '边界路999号', 90.00000000, 180.00000000);

-- ============================================
-- 第四步：插入违建案件数据
-- ============================================
INSERT INTO violation_case (
    building_type, geolocation_id, construction_unit, land_area, building_area, 
    violation_area, start_date, permit_status, discovery_date, land_type, 
    violation_reason, case_source, engineering_category
) VALUES
('自建房', 1, '个人', 120.50, 240.00, 80.00, '2023-03-15', '未报建', '2023-05-20', '宅基地', 
 '未取得建设许可擅自建设，超出批准建筑面积', '巡查发现', '住宅'),
('商铺', 2, '个体户', 80.00, 160.00, 60.00, '2023-06-01', '未报建', '2023-07-10', '宅基地', 
 '未经批准私自加层，存在安全隐患', '巡查发现', '商业'),
('别墅', 3, 'XX房地产开发有限公司', 500.00, 1200.00, 300.00, '2023-01-10', '已报建', '2023-04-18', '商业用地', 
 '超出规划许可范围建设，私自扩建地下室', '群众举报', '住宅'),
('厂房', 4, 'XX工厂', 2000.00, 3000.00, 1500.00, '2022-12-01', '未报建', '2023-01-15', '工业用地', 
 '未经许可私自建设厂房，占用公共用地', '卫星监测', '工业'),
('仓库', 5, 'XX物流公司', 800.00, 1000.00, 400.00, '2023-02-01', '已报建', '2023-03-05', '工业用地', 
 '超范围建设仓库，影响周边环境', '投诉举报', '工业'),
('车库', 6, '小区业主', 30.00, 40.00, 20.00, '2023-04-01', '未报建', '2023-05-01', '宅基地', 
 '私自建设车库，占用公共绿地', '邻里举报', '住宅'),
('阳光房', 7, '个人', 15.00, 25.00, 10.00, '2023-05-15', '未报建', '2023-06-20', '宅基地', 
 '阳台搭建阳光房，影响采光', '巡查发现', '住宅'),
('办公楼', 8, 'XX科技公司', 1000.00, 2000.00, 500.00, '2023-01-01', '已报建', '2023-02-10', '商业用地', 
 '超面积建设办公楼，未按规划执行', '规划检查', '商业'),
('宿舍', 9, 'XX工厂', 500.00, 800.00, 200.00, '2023-03-01', '未报建', '2023-04-01', '工业用地', 
 '私自建设员工宿舍，存在安全隐患', '安监检查', '住宅'),
('测试建筑', 10, '测试单位', 0.01, 0.01, 0.01, '2023-01-01', '未报建', '2023-01-02', '测试用地', 
 '测试违建原因', '测试来源', '测试'),
('大型建筑', 11, '测试大型单位', 999999.99, 999999.99, 999999.99, '2023-12-31', '已报建', '2023-12-31', '特殊用地', 
 '超大规模违建测试', '测试来源', '测试');

-- ============================================
-- 第五步：插入进度数据
-- ============================================
INSERT INTO demolition_progress (case_id, demolition_stage, demolition_date) VALUES
(1, '发责令停止通知书', '2023-05-25'),
(1, '停水停电', '2023-06-01'),
(2, '发责令停止通知书', '2023-07-15'),
(3, '发责令停止通知书', '2023-04-25'),
(4, '发责令停止通知书', '2023-01-20'),
(5, '发责令停止通知书', '2023-03-10'),
(6, '发责令停止通知书', '2023-05-05'),
(7, '发责令停止通知书', '2023-06-25'),
(8, '发责令停止通知书', '2023-02-15'),
(9, '发责令停止通知书', '2023-04-05'),
(10, '测试阶段', '2023-01-01'),
(11, '测试阶段', '2023-12-31');

INSERT INTO building_violation_progress (case_id, status_description, status_date) VALUES
(1, '基础施工完成', '2023-04-01'),
(2, '基础开挖', '2023-06-05'),
(3, '主体完工', '2023-03-20'),
(4, '地基开挖', '2022-12-15'),
(5, '基础施工', '2023-02-05'),
(6, '基础开挖', '2023-04-01'),
(7, '建设中', '2023-05-20'),
(8, '建设中', '2023-01-10'),
(9, '建设中', '2023-03-01'),
(10, '测试状态', '2023-01-01'),
(11, '测试状态', '2023-12-31');

-- ============================================
-- 第六步：正确验证数据完整性（修复版）
-- ============================================

-- 验证总记录数
SELECT 
    '数据量验证' AS 验证项,
    (SELECT COUNT(*) FROM geographical_location) AS 地理位置,
    (SELECT COUNT(*) FROM violation_case) AS 案件,
    (SELECT COUNT(*) FROM demolition_progress) AS 拆除进度,
    (SELECT COUNT(*) FROM building_violation_progress) AS 建筑状态;

-- 验证案件表 → 地理位置表 外键有效性
SELECT 
    '案件→地理位置外键' AS 验证项,
    COUNT(*) AS 引用总数,
    SUM(CASE WHEN gl.id IS NULL THEN 1 ELSE 0 END) AS 无效引用数
FROM violation_case vc
LEFT JOIN geographical_location gl ON vc.geolocation_id = gl.id;

-- 验证拆除进度表 → 案件表 外键有效性
SELECT 
    '拆除进度→案件外键' AS 验证项,
    COUNT(*) AS 引用总数,
    SUM(CASE WHEN vc.id IS NULL THEN 1 ELSE 0 END) AS 无效引用数
FROM demolition_progress dp
LEFT JOIN violation_case vc ON dp.case_id = vc.id;

-- 验证建筑状态表 → 案件表 外键有效性
SELECT 
    '建筑状态→案件外键' AS 验证项,
    COUNT(*) AS 引用总数,
    SUM(CASE WHEN vc.id IS NULL THEN 1 ELSE 0 END) AS 无效引用数
FROM building_violation_progress bvp
LEFT JOIN violation_case vc ON bvp.case_id = vc.id;

-- 提交事务
COMMIT;

SELECT '✅ 测试数据重置成功！' AS 结果;